From d8440f4d711a654b511f50f79c0445b26f9dd1e1 Mon Sep 17 00:00:00 2001
From: Nanang Izzuddin <nanang@teluu.com>
Date: Tue, 20 Dec 2022 11:39:12 +0700
Subject: [PATCH] Merge pull request from GHSA-9pfh-r8x4-w26w

* Fix buffer overread in STUN message decoder

* Updates based on comments

[Retrieved from:
https://github.com/pjsip/pjproject/commit/d8440f4d711a654b511f50f79c0445b26f9dd1e1]

--- pjsip-2.12.1/pjnath/include/pjnath/stun_msg.h.orig	2022-05-09 23:10:42.000000000 -0500
+++ pjsip-2.12.1/pjnath/include/pjnath/stun_msg.h	2023-03-02 08:58:36.896258562 -0600
@@ -443,6 +443,7 @@
 
    \endverbatim
  */
+#pragma pack(1)
 typedef struct pj_stun_msg_hdr
 {
     /**
@@ -474,6 +475,7 @@
     pj_uint8_t		tsx_id[12];
 
 } pj_stun_msg_hdr;
+#pragma pack()
 
 
 /**
@@ -491,6 +493,7 @@
 
    \endverbatim
  */
+#pragma pack(1)
 typedef struct pj_stun_attr_hdr
 {
     /**
@@ -507,6 +510,7 @@
     pj_uint16_t		length;
 
 } pj_stun_attr_hdr;
+#pragma pack()
 
 
 /**
--- pjsip-2.12.1/pjnath/src/pjnath/stun_msg.c.orig	2022-05-09 23:10:42.000000000 -0500
+++ pjsip-2.12.1/pjnath/src/pjnath/stun_msg.c	2023-03-02 08:58:36.896258562 -0600
@@ -747,7 +747,7 @@
 
 #define INIT_ATTR(a,t,l)    (a)->hdr.type=(pj_uint16_t)(t), \
 			    (a)->hdr.length=(pj_uint16_t)(l)
-#define ATTR_HDR_LEN	    4
+#define ATTR_HDR_LEN        sizeof(pj_stun_attr_hdr)
 
 static pj_uint16_t GETVAL16H(const pj_uint8_t *buf, unsigned pos)
 {
@@ -2328,6 +2328,14 @@
 	status = pj_stun_msg_check(pdu, pdu_len, options);
 	if (status != PJ_SUCCESS)
 	    return status;
+    } else {
+        /* For safety, verify packet length at least */
+        pj_uint32_t msg_len = GETVAL16H(pdu, 2) + 20;
+        if (msg_len > pdu_len ||
+            ((options & PJ_STUN_IS_DATAGRAM) && msg_len != pdu_len))
+        {
+            return PJNATH_EINSTUNMSGLEN;
+        }
     }
 
     /* Create the message, copy the header, and convert to host byte order */
@@ -2346,7 +2354,7 @@
 	p_response = NULL;
 
     /* Parse attributes */
-    while (pdu_len >= 4) {
+    while (pdu_len >= ATTR_HDR_LEN) {
 	unsigned attr_type, attr_val_len;
 	const struct attr_desc *adesc;
 
@@ -2358,7 +2366,7 @@
 	attr_val_len = (attr_val_len + 3) & (~3);
 
 	/* Check length */
-	if (pdu_len < attr_val_len) {
+        if (pdu_len < attr_val_len + ATTR_HDR_LEN) {
 	    pj_str_t err_msg;
 	    char err_msg_buf[80];
 
