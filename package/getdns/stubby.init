#!/bin/sh

. /etc/rc.conf

PIDFILE="/var/run/stubby/stubby.pid"

gen_stubby_conf()
{
  local x addr port IFS

  if [ -f /mnt/kd/stubby/stubby.yml ]; then
    echo "# Autogenerated.  Edit /mnt/kd/stubby/stubby.yml file.
#"
    cat /mnt/kd/stubby/stubby.yml
  else
    echo "# Autogenerated.  Do not edit.
# A manually generated stubby config will use /mnt/kd/stubby/stubby.yml if it exists.
resolution_type: GETDNS_RESOLUTION_STUB
dns_transport_list:
  - GETDNS_TRANSPORT_TLS
tls_authentication: GETDNS_AUTHENTICATION_REQUIRED
tls_query_padding_blocksize: 128
edns_client_subnet_private: 1
idle_timeout: 10000
listen_addresses:
  - 127.0.0.1@2853
round_robin_upstreams: 1
upstream_recursive_servers:"

    # Default to Quad9 TLS for IPv4
    unset IFS
    for x in ${DNS_TLS_SERVERS:-9.9.9.9~dns.quad9.net 149.112.112.112~dns.quad9.net}; do
      addr="$(echo "$x" | cut -d'~' -f1)"
      name="$(echo "$x" | cut -s -d'~' -f2)"
      port="$(echo "$x" | cut -s -d'~' -f3)"
      if [ -z "$name" ]; then
        logger -s -t stubby -p kern.info "invalid DNS_TLS_SERVERS variable, entry missing tls_auth_name, failed to start."
        return 1
      fi
      echo "  - address_data: ${addr}"
      echo "    tls_port: ${port:-853}"
      echo "    tls_auth_name: \"${name}\""
    done
  fi

  return 0
}

init () {

  if [ "$DNS_TLS_PROXY" != "yes" ]; then
    if [ -f /tmp/etc/stubby/stubby.yml ]; then
      rm /tmp/etc/stubby/stubby.yml
    fi
    exit 0
  fi

  if [ ! -d /tmp/etc/stubby ]; then
    mkdir -p /tmp/etc/stubby
  fi

  gen_stubby_conf > /tmp/etc/stubby/stubby.yml
  if [ $? -ne 0 ]; then
    rm -f /tmp/etc/stubby/stubby.yml
    exit 1
  fi

  mkdir -p /var/run/stubby
  chown nobody:nobody /var/run/stubby
}

start () {

  if [ -f /etc/stubby/stubby.yml ]; then
    echo "Starting DNS-TLS Proxy (stubby)..."

    ARGS="-g -C /etc/stubby/stubby.yml"

    start-stop-daemon -S -x /usr/bin/stubby -p $PIDFILE -u nobody --chuid nobody:nobody -- $ARGS
    if [ $? -eq 0 ]; then
      logger -t stubby -p kern.info "Starting stubby $(stubby -V), DNS-TLS Proxy"
    else
      logger -t stubby -p kern.info "Failed starting stubby $(stubby -V), DNS-TLS Proxy"
    fi
  fi
}

stop () {

  if [ -f $PIDFILE ]; then
    echo "Stopping DNS-TLS Proxy (stubby)..."

    start-stop-daemon -K -q -n stubby -p $PIDFILE -u nobody -s TERM
    rm -f $PIDFILE
    logger -t stubby -p kern.info "Stopping stubby, DNS-TLS Proxy"
  fi
}

case $1 in

start)
  start
  ;;

stop)
  stop
  ;;

init)
  init
  start
  ;;

restart)
  stop
  sleep 2
  start
  ;;

*)
  echo "Usage: start|stop|restart"
  ;;

esac

