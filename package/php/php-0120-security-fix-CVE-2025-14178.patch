From: Niels Dossche <7771979+ndossche@users.noreply.github.com>
Date: Sun, 9 Nov 2025 13:23:11 +0100
Subject: Fix GHSA-h96m-rvf9-jgm2

(cherry picked from commit 8b801151bd54b36aae4593ed6cfc096e8122b415)
(cherry picked from commit e4516e52979e8b67d9d35dfdbcc5dc7368263fa2)
---
 ext/standard/array.c                              |  7 ++++++-
 2 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/ext/standard/array.c b/ext/standard/array.c
index 09c3a9f..fd92ef0 100644
--- a/ext/standard/array.c
+++ b/ext/standard/array.c
@@ -3836,7 +3836,7 @@ static inline void php_array_merge_or_replace_wrapper(INTERNAL_FUNCTION_PARAMETE
 	} else {
 		zval *src_entry;
 		HashTable *src, *dest;
-		uint32_t count = 0;
+		uint64_t count = 0;
 
 		for (i = 0; i < argc; i++) {
 			zval *arg = args + i;
@@ -3848,6 +3848,11 @@ static inline void php_array_merge_or_replace_wrapper(INTERNAL_FUNCTION_PARAMETE
 			count += zend_hash_num_elements(Z_ARRVAL_P(arg));
 		}
 
+		if (UNEXPECTED(count >= HT_MAX_SIZE)) {
+			zend_throw_error(NULL, "The total number of elements must be lower than %u", HT_MAX_SIZE);
+			return;
+		}
+
 		arg = args;
 		src  = Z_ARRVAL_P(arg);
 		/* copy first array */
